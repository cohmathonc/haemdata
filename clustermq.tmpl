#!/bin/sh
# Modified from https://github.com/mschubert/clustermq/blob/master/inst/SLURM.tmpl
# under the Apache 2.0 license.
#SBATCH --job-name={{ job_name }}
#SBATCH --output={{ log_file | /dev/null }}
#SBATCH --error={{ log_file | /dev/null }}
#SBATCH --mem={{ memory | 80G }}
#SBATCH --array=1-{{ n_jobs }}
#SBATCH --cpus-per-task={{ cores | 12 }}

ulimit -v $(( 1024 * {{ memory | 4096 }} ))

/opt/singularity/3.7.0/bin/singularity exec \
    --cleanenv --env CMQ_AUTH="{{ auth }}" \
    -H $HOME/.singularity/home:/home/$USER \
    /opt/singularity-images/kmorris/rbioc_3.14.005.sif \
    R --no-save --no-restore -e 'clustermq:::worker("{{ master }}")'
