```{r}
pak::pak(c("langevitour", "airway", "edgeR", "limma", "MASS", "EnsDb.Hsapiens.v86", "ggplot2", "dplyr", "tibble"))


library(langevitour)
library(airway)               # airway dataset
library(edgeR)                # RPM calculation
library(limma)                # makeContrasts
library(MASS)                 # ginv generalized matrix inverse
library(EnsDb.Hsapiens.v86)   # Gene names
library(ggplot2)
library(dplyr)
library(tibble)

data(airway)

treatment <- colData(airway)$dex == "trt"
cell <- factor(c(1,1,2,2,3,3,4,4))
design <- model.matrix(~ 0 + cell + treatment)

dge <- airway |>
    assay("counts") |>
    DGEList() |>
    calcNormFactors()

# Convert to log2 Reads Per Million.
# prior.count=5 applies some moderation for counts near zero.
rpms <- cpm(dge, log=TRUE, prior.count=5)

# Only show variable genes (mostly for speed)
keep <- apply(rpms,1,sd) >= 0.25
table(keep)
y <- rpms[keep,,drop=F]

# Use shorter sample names
colnames(y) <- paste0(ifelse(treatment,"T","U"), cell)

# Get friendly gene names
symbols <- 
    AnnotationDbi::select(EnsDb.Hsapiens.v86, keys=rownames(y), keytype="GENEID", columns="SYMBOL") |>
    deframe()
name <- symbols[rownames(y)]
name[is.na(name)] <- rownames(y)[is.na(name)]

# Colors for the samples
colors <- ifelse(treatment,"#f00","#080")
```