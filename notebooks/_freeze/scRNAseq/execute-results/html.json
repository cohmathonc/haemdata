{
  "hash": "68a2a35fab3e0fa86316380cbe50218f",
  "result": {
    "markdown": "---\ntitle: \"scRNAseq\"\n---\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(haemdata)\nlibrary(Seurat)\nlibrary(patchwork)\nlibrary(ggplot2)\nlibrary(scCustomize)\nlibrary(dplyr)\n```\n:::\n\n\n<details>\n<summary>Show/hide helper functions code</summary>\n\n::: {.cell}\n\n```{.r .cell-code}\n#' Make a simplified UMAP plot\n#'\n#' See https://twitter.com/samuel_marsh/status/1526550833479008257\n#' Code https://twitter.com/timoast/status/1526237116035891200/photo/1\n#'\n#' @param x a ggpplot object from Seurat::DimPlot\n#' @return a DimPlot with a simplified UMAP theme\n#' @rdname dim_plot_mod\ndim_plot_mod <- function(x) {\n    p1 <- x + theme_void()\n    p2 <- ggplot(data.frame(x = 100, y = 100), aes(x = x, y = y)) +\n        geom_point() +\n        xlim(c(0, 10)) +\n        ylim(c(0, 10)) +\n        theme_classic() +\n        ylab(\"UMAP2\") +\n        xlab(\"UMAP1\") +\n        theme(\n            axis.text.y = element_blank(),\n            axis.text.x = element_blank(),\n            axis.ticks = element_blank(),\n            axis.line = element_line(\n                arrow = arrow(length = unit(0.5, \"cm\"), type = \"closed\")\n            )\n        )\n    layout <- c(\n        patchwork::area(t = 1, l = 2, b = 11, r = 11),\n        patchwork::area(t = 10, l = 1, b = 12, r = 2)\n    )\n\n    p1 + p2 + patchwork::plot_layout(design = layout)\n}\n\n#' Make a QC patchwork plot of per-sample scRNAseq data\n#' - Genes per cell\n#' - UMIs per cell\n#' - log(UMIs per cell)\n#' - % mtDNA per cell\n#'\n#' See https://samuel-marsh.github.io/scCustomize/articles/QC_Plots.html\n#'\n#' @param seurat_object a Seurat object\n#' @return a patchwork plot of the QC data\n#' @rdname dim_plot_mod\nsc_qc_plot_per_sample <- function(seurat_object) {\n    pal <- scCustomize::DiscretePalette_scCustomize(num_colors = 30, palette = \"ditto_seq\")\n    Seurat::Idents(seurat_object) <- \"orig.ident\"\n    n1 <- scCustomize::QC_Plot_UMIvsGene(\n        seurat_object,\n        low_cutoff_gene = 800,\n        high_cutoff_gene = 5500,\n        low_cutoff_UMI = 500,\n        high_cutoff_UMI = 50000,\n        colors_use = pal,\n        x_axis_label = \"UMIs per Cell\",\n        y_axis_label = \"Genes per Cell\"\n    ) +\n        theme(legend.position = \"none\", axis.text.x = element_text(angle = 45, hjust = 1)) +\n        labs(title = \"Cells by Sample ID\")\n    n2 <- scCustomize::QC_Plot_UMIvsGene(\n        seurat_object,\n        meta_gradient_name = \"percent_mt\",\n        low_cutoff_gene = 800,\n        high_cutoff_gene = 5500,\n        high_cutoff_UMI = 45000,\n        x_axis_label = \"UMIs per Cell\",\n        y_axis_label = \"Genes per Cell\"\n    ) +\n        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n        labs(title = \"Cells by % mtDNA\")\n\n    upper <- patchwork::wrap_plots(n1, n2, nrow = 1)\n\n    p1 <- scCustomize::QC_Plots_Genes(seurat_object, low_cutoff = 800, high_cutoff = 5500, pt.size = 0, plot_title = \"Genes per cell\", raster = TRUE, colors_use = pal)\n    p2 <- scCustomize::QC_Plots_Feature(seurat_object, feature = \"percent_ribo\", low_cutoff = 5, pt.size = 0, plot_title = \"% rRNA per cell\", raster = TRUE, colors_use = pal)\n    p3 <- scCustomize::QC_Plots_UMIs(seurat_object, low_cutoff = 1200, high_cutoff = 45000, pt.size = 0, y_axis_log = TRUE, plot_title = \"log(UMIs per cell)\", raster = TRUE, colors_use = pal)\n    p4 <- scCustomize::QC_Plots_Feature(seurat_object, feature = \"percent_mt\", high_cutoff = 20, pt.size = 0, plot_title = \"% mtDNA per cell\", raster = TRUE, colors_use = pal)\n\n    lower <- patchwork::wrap_plots(p1, p2, p3, p4, nrow = 2) &\n        ggplot2::theme(plot.title = element_text(size = 10), legend.position = \"none\", axis.text = element_text(size = 8))\n\n    patchwork::wrap_plots(upper, lower, nrow = 2)\n}\n\n#' Make a QC plot of per-sample median per-cell values\n#' Median values per sample:\n#' - Genes per cell\n#' - UMIs per cell\n#' - percent mt per cell\n#'\n#' See https://samuel-marsh.github.io/scCustomize/articles/QC_Plots.html\n#'\n#' @param seurat_object a Seurat object\n#' @param group_by a meta.data column with fewer than 8 unique values to group by\n#' @return a patchwork plot of the QC data\n#' @rdname dim_plot_mod\nsc_qc_plot_group_by <- function(seurat_object, group_by) {\n    pal <- scCustomize::DiscretePalette_scCustomize(num_colors = 30, palette = \"ditto_seq\")\n\n    d1 <- Seurat::DimPlot(seurat_object, reduction = \"umap\", group.by = {{ group_by }}, cols = pal) |>\n        dim_plot_mod()\n    my_theme <- ggplot2::theme(plot.title = element_blank(), legend.position = \"none\", axis.text.y = element_text(size = 9))\n    p1 <- scCustomize::Plot_Median_Genes(seurat_object, group_by = {{ group_by }}, colors_use = pal) + my_theme\n    p2 <- scCustomize::Plot_Median_UMIs(seurat_object, group_by = {{ group_by }}, colors_use = pal) + my_theme\n    p3 <- scCustomize::Plot_Median_Other(seurat_object, median_var = \"percent_mt\", group_by = {{ group_by }}, colors_use = pal) + my_theme\n    p4 <- scCustomize::Plot_Median_Other(seurat_object, median_var = \"percent_ribo\", group_by = {{ group_by }}, colors_use = pal) + my_theme\n    p5 <- scCustomize::Plot_Median_Other(seurat_object, median_var = \"percent_myh11\", group_by = {{ group_by }}, colors_use = pal) + my_theme\n    p6 <- scCustomize::Plot_Cells_per_Sample(seurat_object, group_by = {{ group_by }}, colors_use = pal) + my_theme\n\n    layout <- \"\n        AAA#G\n        AAA#G\n        BCDEF\n        \"\n\n    patchwork::wrap_plots(A = d1, B = p1, C = p2, D = p3, E = p4, F = p5, G = p6, design = layout)\n}\n```\n:::\n\n\n</details>\n\n::: {.panel-tabset}\n\n## AML 2022 scRNAseq\n\n\n::: {.cell}\n\n```{.r .cell-code}\nuse_pinboard(\"devel\")\nseurat_object <- get_pin(\"mmu_10x_aml2022_GENCODEm28_HLT.rds\")\n```\n:::\n\n\n### Per cell metadata\n\n::: {.cell}\n\n```{.r .cell-code}\nseurat_object@meta.data |> colnames()\n#>  [1] \"orig.ident\"       \"nCount_RNA\"       \"nFeature_RNA\"     \"ref_genome\"      \n#>  [5] \"tissue\"           \"ckit\"             \"percent_mt\"       \"percent_ribo\"    \n#>  [9] \"percent_hb\"       \"percent_platelet\" \"percent_xist\"     \"chrY_counts\"     \n#> [13] \"percent_myh11\"    \"nCount_SCT\"       \"nFeature_SCT\"     \"SCT_snn_res.0.4\" \n#> [17] \"seurat_clusters\"  \"SCT_snn_res.0.6\"  \"SCT_snn_res.0.8\"  \"SCT_snn_res.1\"   \n#> [21] \"SCT_snn_res.1.2\"  \"SCT_snn_res.0.2\"  \"S.Score\"          \"G2M.Score\"       \n#> [25] \"Phase\"            \"cell_type\"        \"cell_type_fine\"\n```\n:::\n\n\nNumber of samples: **21**; total number of cells: **105170**\n\n### Per sample QC metrics\n\n::: {.cell}\n\n```{.r .cell-code}\nsc_qc_plot_per_sample(seurat_object)\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-5-1.png){width=100% height=100%}\n:::\n:::\n\n\n### Per sample UMAP\n\n::: {.cell}\n\n```{.r .cell-code}\npal <- scCustomize::DiscretePalette_scCustomize(num_colors = 30, palette = \"ditto_seq\")\nscCustomize::DimPlot_scCustom(seurat_object, reduction = \"umap\", group.by = \"orig.ident\", colors_use = pal) |>\n    dim_plot_mod() + ggplot2::guides(color = ggplot2::guide_legend(ncol = 2))\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-6-1.png){width=100% height=100%}\n:::\n:::\n\n\n### Per cell QC metrics\n\n::: {.cell}\n\n```{.r .cell-code}\nsc_qc_plot_group_by(seurat_object, \"tissue\")\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-7-1.png){width=100% height=100%}\n:::\n\n```{.r .cell-code}\nsc_qc_plot_group_by(seurat_object, \"ckit\")\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-7-2.png){width=100% height=100%}\n:::\n\n```{.r .cell-code}\nsc_qc_plot_group_by(seurat_object, \"Phase\")\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-7-3.png){width=100% height=100%}\n:::\n\n```{.r .cell-code}\nsc_qc_plot_group_by(seurat_object, \"cell_type\")\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-7-4.png){width=100% height=100%}\n:::\n\n```{.r .cell-code}\ngc()\n#>              used    (Mb) gc trigger    (Mb)   max used    (Mb)\n#> Ncells    8481686   453.0   13571610   724.9   13571610   724.9\n#> Vcells 3003399908 22914.2 4589012706 35011.4 3096766640 23626.5\n```\n:::\n\n\n## CML miR-142 KO scRNAseq (LMPP & T cell)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nuse_pinboard(\"devel\")\nseurat_object <- get_pin(\"mmu_10x_mir142ko_GENCODEm28_HLT.rds\")\n```\n:::\n\n\n### Per cell metadata\n\n::: {.cell}\n\n```{.r .cell-code}\nseurat_object@meta.data |> colnames()\n#>  [1] \"orig.ident\"       \"nCount_RNA\"       \"nFeature_RNA\"     \"ref_genome\"      \n#>  [5] \"percent_mt\"       \"percent_ribo\"     \"percent_hb\"       \"percent_platelet\"\n#>  [9] \"percent_xist\"     \"chrY_counts\"      \"percent_myh11\"    \"nCount_SCT\"      \n#> [13] \"nFeature_SCT\"     \"SCT_snn_res.0.4\"  \"seurat_clusters\"  \"SCT_snn_res.0.6\" \n#> [17] \"SCT_snn_res.0.8\"  \"SCT_snn_res.1\"    \"SCT_snn_res.1.2\"  \"SCT_snn_res.0.2\" \n#> [21] \"S.Score\"          \"G2M.Score\"        \"Phase\"            \"cell_type\"       \n#> [25] \"cell_type_fine\"\n```\n:::\n\n\nNumber of samples: **18**; total number of cells: **166118**\n\n\n### Per sample QC metrics\n\n::: {.cell}\n\n```{.r .cell-code}\nsc_qc_plot_per_sample(seurat_object)\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-10-1.png){width=100% height=100%}\n:::\n:::\n\n\n### Per sample UMAP\n\n::: {.cell}\n\n```{.r .cell-code}\npal <- scCustomize::DiscretePalette_scCustomize(num_colors = 30, palette = \"ditto_seq\")\nscCustomize::DimPlot_scCustom(seurat_object, reduction = \"umap\", group.by = \"orig.ident\", colors_use = pal) |>\n    dim_plot_mod() + ggplot2::guides(color = ggplot2::guide_legend(ncol = 2))\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-11-1.png){width=100% height=100%}\n:::\n:::\n\n\n### Per cell QC metrics\n\n::: {.cell}\n\n```{.r .cell-code}\nsc_qc_plot_group_by(seurat_object, \"seurat_clusters\")\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-12-1.png){width=100% height=100%}\n:::\n\n```{.r .cell-code}\nsc_qc_plot_group_by(seurat_object, \"Phase\")\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-12-2.png){width=100% height=100%}\n:::\n\n```{.r .cell-code}\nsc_qc_plot_group_by(seurat_object, \"cell_type\")\n```\n\n::: {.cell-output-display}\n![](scRNAseq_files/figure-html/unnamed-chunk-12-3.png){width=100% height=100%}\n:::\n:::\n\n\n:::\n\n# Using Python?\n\nhttps://mojaveazure.github.io/seurat-disk/articles/convert-anndata.html",
    "supporting": [
      "scRNAseq_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}